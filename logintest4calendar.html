<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google Takvim Entegrasyonu</title>
  <style>
    .card {
      border: 1px solid #ccc;
      padding: 20px;
      margin: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .profile-info {
      margin-top: 20px;
    }
    .profile-info img {
      border-radius: 50%;
      width: 50px;
      height: 50px;
    }
    #logout-button {
      display: none;
      margin-top: 10px;
      background-color: red;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
    }
    #access-denied {
      display: none;
      color: red;
      margin-top: 20px;
    }
    #calendar-events {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h2>Google ile Giriş Yap</h2>
    <div id="oauth-button"></div>

    <div id="profile-info" class="profile-info" style="display: none;">
      <img id="profile-pic" src="" alt="Profil Resmi">
      <p id="profile-name"></p>
      <p id="profile-email"></p>
      <button id="logout-button" onclick="logout()">Çıkış Yap</button>
    </div>

    <div id="access-denied">
      <p>Bu sayfaya erişim izniniz yok.</p>
    </div>

    <div id="calendar-events">
      <h3>Haftalık Takvim Etkinlikleri</h3>
      <ul id="events-list"></ul>
    </div>
  </div>

  <!-- Google API Scriptleri -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js" async defer></script>

  <script>
    const allowedEmails = [
      "yapiisleribanu@gmail.com",
      "mahmutkilicankara@gmail.com",
      "izinli3@example.com"
    ];

    // Google Identity Services ile giriş yap
    window.onload = () => {
      google.accounts.id.initialize({
        client_id: "387277586108-8m32c8tdfb0oemnr5kuv2fao6rtm35c0.apps.googleusercontent.com",
        callback: handleCredentialResponse
      });
      google.accounts.id.renderButton(
        document.getElementById("oauth-button"),
        { theme: "outline", size: "large" }
      );

      const storedUser = localStorage.getItem("googleUser");
      if (storedUser) {
        const user = JSON.parse(storedUser);
        if (allowedEmails.includes(user.email)) {
          displayUserInfo(user);
          initGapiClient();
        } else {
          showAccessDenied();
        }
      }
    };

    // Kullanıcı giriş yaptığında çalışır
    function handleCredentialResponse(response) {
      const user = parseJwt(response.credential);

      if (allowedEmails.includes(user.email)) {
        localStorage.setItem("googleUser", JSON.stringify(user));
        displayUserInfo(user);
        initGapiClient();
      } else {
        showAccessDenied();
      }
    }

    // JWT token'ını parse et
    function parseJwt(token) {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(c =>
        '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
      ).join(''));
      return JSON.parse(jsonPayload);
    }

    // Kullanıcı bilgilerini göster
    function displayUserInfo(user) {
      document.getElementById("profile-pic").src = user.picture;
      document.getElementById("profile-name").textContent = user.name;
      document.getElementById("profile-email").textContent = user.email;
      document.getElementById("profile-info").style.display = "block";
      document.getElementById("oauth-button").style.display = "none";
      document.getElementById("logout-button").style.display = "block";
    }

    // Erişim reddedildi mesajını göster
    function showAccessDenied() {
      document.getElementById("access-denied").style.display = "block";
    }

    // Google API istemcisini başlat
    function initGapiClient() {
      gapi.load("client:auth2", () => {
        gapi.client.init({
          apiKey: "AIzaSyDFCb2Rjt--IcOuhZoxcbuRlUow_xBnXjQ",
          discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],
          clientId: "387277586108-8m32c8tdfb0oemnr5kuv2fao6rtm35c0.apps.googleusercontent.com",
          scope: "https://www.googleapis.com/auth/calendar.readonly"
        }).then(() => {
          // Kullanıcı oturumunu kontrol et
          if (gapi.auth2.getAuthInstance().isSignedIn.get()) {
            fetchCalendarEvents();
          } else {
            // Kullanıcı oturum açmamışsa oturum açmasını iste
            gapi.auth2.getAuthInstance().signIn();
          }
        }, (error) => {
          console.error("Google API başlatma hatası:", error);
        });
      });
    }

    // Takvim etkinliklerini al
    function fetchCalendarEvents() {
      const now = new Date();
      const nextWeek = new Date();
      nextWeek.setDate(now.getDate() + 7);

      gapi.client.calendar.events.list({
        calendarId: "primary",
        timeMin: now.toISOString(),
        timeMax: nextWeek.toISOString(),
        showDeleted: false,
        singleEvents: true,
        orderBy: "startTime"
      }).then(response => {
        const events = response.result.items;
        const eventsList = document.getElementById("events-list");
        eventsList.innerHTML = "";

        if (events.length > 0) {
          events.forEach(event => {
            const li = document.createElement("li");
            li.textContent = `${event.summary} - ${event.start.dateTime || event.start.date}`;
            eventsList.appendChild(li);
          });
        } else {
          eventsList.innerHTML = "Bu hafta için etkinlik yok.";
        }
      }, (error) => {
        console.error("Takvim etkinlikleri alınırken hata:", error);
      });
    }

    // Çıkış yap
    function logout() {
      localStorage.removeItem("googleUser");
      if (gapi.auth2.getAuthInstance()) {
        gapi.auth2.getAuthInstance().signOut();
      }
      window.location.reload();
    }
  </script>
</body>
</html>
